<!-- templates/index.html -->
{% extends 'base-layout-2col.html' %}

{% block title %}Главная{% endblock %}

{% block content %}
<div class="itinerary-left" data-session-id="{{ session.id }}">
  {% include 'partials/header.html' %}  <!-- Вставка общего header -->
  <div class="itinerary-content">
    <h1 class="h1-low-margin">{{ route.title }}</h1>
    <div class="itinerary-actions">
      <button class="btn-secondary btn-with-icon"><i class="material-icons-round">download</i>Скачать PDF маршрута</button>
      <button class="btn-secondary btn-with-icon"><i class="material-icons-round">person_add</i>Пригласить</button>
    </div>
    <div class="itinerary-date-picker">
      <h2>Даты поездки</h2>
      <div class="date-block">
        <label>
          <input type="date" value="{{session.start_date}}" id="start-date">
        </label>
    
        <div class="return-date-block">
          <div class="return-date-label">
            Обратно — <span class="return-date-value">20 июля</span>
          </div>
          <div class="return-date-controls">
            <button class="btn-xs">+1 день</button>
            <button class="btn-xs">+2 дня</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="box">
    <h2>Выбор транспорта</h2>
    
    <form method="post">
      {% if transports["there"]|length != 0 %}
      {% for direction, trips in transports.items() %}
          {% if direction == "there"%}
            <h3>Туда:</h3>
          {% else %}
            <h3>Обратно:</h3>
          {% endif %}
          {% for t in trips[:5] %}
            <label>
              <input onchange="updateBudget()" type="radio" name="transport_{{direction}}" value="{{ t.id }}" data-cost="{{ t.end_cost_rub }}">
              {{ t.transport_type }}: {{ t.title }} Прибытие: {{t.arrival}} Отбытие: {{t.departure}}
              (~{{ t.duration_min }} мин, {% if t.start_cost_rub == None %}информации о цене нет{%else%} {{t.start_cost_rub}}₽{%endif%})
            </label><br>
          {% endfor %}
          {% endfor %}
          {% else %}
              Рейсов из {{session.city.name}} в {{route.cities[0].city.name}} на {{session.start_date}} не найдено. Попробуйте поменять даты поездки
          {% endif %}
    
    </div>
    
    <div class="box">
      {% for d in days %}
        <h3 class="section-title">День {{ d.day_order }}</h3>
        {% for s in d.segments %}
          <div class="segment">
            {% if s.type == 'poi' %}
              <p><b>{{ s.poi_name }}</b> — {{ s.arrival_window }} (Рейтинг: {{ s.rating }})</p>
            {% elif s.type == 'meal' %}
            <form method="post">
            <p>Обед:</p>
            {% set meals = s.meal_options_json | safe | loads %}
            <ul>
              {% for m in meals %}
                <label>
                  <input onchange="updateBudget()" type="radio" name="meal" value="{{ m.id }}" data-cost="{{ m.avg_check_rub }}">
                    {{ m.name }} — {{ m.avg_check_rub }}₽
                </label><br>
                {% endfor %}
              </ul>
            </form>
            {% endif %}
          </div>
        {% endfor %}
        {% if not loop.last and d.lodgings %}
        <p>Ночлег:</p>
          {% for l in d.lodgings %}
            <label>
              <input onchange="updateBudget()" type="radio" name="lodgings"> {{l.type}} - {{ l.name }} {{l.distance_km }} км от центра
            </label>
          {% endfor %}
        {% endif %}
      {% endfor %}
    </div>
    
    <div class="budget-box">
      <strong>Оценка бюджета:</strong> <span id="budgetAmount">0</span> ₽
    </div>
  </div>
</div>
<div class="itinerary-right">
    <div id="map" class="map-box"></div>
</div>

{% endblock %}

{% block script %}

<script>
  const sessionId = document.getElementsByClassName("itinerary-left")[0].dataset.sessionId
  const startDateInput = document.getElementById("start-date")
  const startDateValue = startDateInput.value

  startDateInput.addEventListener('change', async () => {
    const resp = await fetch('/api/session/update_transports', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({startDateValue, sessionId})
    });
    console.log(resp.body);
  });

  
  function updateBudget() {
    const items = document.querySelectorAll('input[type="radio"][data-cost]:checked')
    let total = 0;
    items.forEach(item => {
      const cost = parseFloat(item.dataset.cost)
      total += isNaN(cost) ? 0 : cost;
    })
    document.getElementById('budgetAmount').textContent = total;
  }
</script>

{% endblock %}

