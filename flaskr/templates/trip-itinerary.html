<!-- templates/index.html -->
{% extends 'base.html' %}
{% block title %}Главная{% endblock %}
{% block script %}
  <script crossorigin
          src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
  <script src="https://api-maps.yandex.ru/v3?apikey={{ya_map_js_api_key}}&lang=ru_RU"
          type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp"
        rel="stylesheet">
  <script data-plugins="transform-modules-umd"
          data-presets="react, typescript"
          type="text/babel"
          src="{{url_for('static', filename='js/variables.ts')}}"></script>
  <script data-plugins="transform-modules-umd"
          data-presets="react, typescript"
          type="text/babel"
          src="{{url_for('static', filename='js/common.ts')}}"></script>
  <script data-plugins="transform-modules-umd"
          data-presets="react, typescript"
          type="text/babel"
          src="{{url_for('static', filename='js/index.ts')}}"></script>
  <link rel="stylesheet"
        href="{{ url_for('static', filename='js/common.css') }}" />
  <script defer src="{{url_for('static', filename='js/trip-itinerary.js')}}"></script>
{% endblock %}
{% block body %}
  <body class="layout-2col">
    <div class="itinerary-left px-1" data-session-id="{{ session.id }}">
      {% include 'partials/header.html' %}
      <!-- Вставка общего header -->
      <div class="flex flex-col flex-1 gap-5 overflow-y-auto overflow-x-visible min-w-0">
        <div>
          <h1 class="h1-low-margin">{{ route.title }}</h1>
          <div class="itinerary-actions">
            <button class="btn-secondary btn-with-icon">
              <i class="material-icons-round">download</i>Скачать PDF маршрута
            </button>
            <button class="btn-secondary btn-with-icon">
              <i class="material-icons-round">person_add</i>Пригласить
            </button>
          </div>
        </div>
        <div class="itinerary-date-picker">
          <h2>Даты поездки</h2>
          <div class="date-block">
            <label>
              <input type="date" value="{{ session.start_date }}" id="start-date">
            </label>
            <div class="return-date-block">
              <div class="return-date-label">
                Обратно — <span class="return-date-value">20 июля</span>
              </div>
              <div class="return-date-controls">
                <button class="btn-xs">+1 день</button>
                <button class="btn-xs">+2 дня</button>
              </div>
            </div>
          </div>
        </div>
        <div class="transports-block">
          <h2 class="text-2xl">Выбор транспорта</h2>
          <form method="post" class="flex flex-col gap-5">
            {% if transports["there"]|length != 0 %}
              {% for direction, trips in transports.items() %}
                <div class="flex flex-col gap-4">
                  {% if direction == "there" %}
                    <h3 class="text-lg font-medium text-gray-800 tracking-tight">Туда:</h3>
                  {% else %}
                    <h3 class="text-lg font-medium text-gray-800 tracking-tight">Обратно:</h3>
                  {% endif %}
                  <div class="flex flex-col gap-3">
                    {% for t in trips[:3] %}
                      <label for="transport-{{ t.uid }}">
                        <input class="peer hidden"
                               onchange="updateBudget()"
                               type="radio"
                               name="transport_{{ direction }}"
                               value="{{ t.uid }}"
                               data-cost="{{ t.start_cost_rub }}"
                               id="transport-{{ t.uid }}">
                        <div class="bg-neutral-100 peer-checked:ring-inset peer-checked:ring-2 peer-checked:ring-blue-500 px-5 py-6 rounded-lg cursor-pointer transition">
                          {{ t.transport_type }}
                          <div class="grid grid-cols-3 gap-6">
                            {% macro transport_time_block(datetime, station_title) %}
                              <div>
                                <div class="flex gap-2 items-start">
                                  <span class="text-2xl font-medium">{{ datetime | datetimeformat("HH:mm") }}</span>
                                  {{ datetime | datetimeformat("d MMMM") }}
                                </div>
                                <span class="font-medium">{{ t.from_title }}</span>
                              </div>
                            {% endmacro %}
                            {{ transport_time_block(t.departure, t.from_title) }}
                            {{ transport_time_block(t.arrival, t.to_title) }}
                            <div class="flex flex-col justify-between">
                              <div>{{ t.duration }}</div>
                              <div class="font-medium">
                                {% if t.start_cost_rub == None %}
                                  Информации о цене нет
                                {% else %}
                                  {{ t.start_cost_rub }}₽
                                {% endif %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </label>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              Рейсов из {{ session.city.name }} в {{ route.cities[0].city.name }} на {{ session.start_date }} не найдено. Попробуйте поменять даты поездки
            {% endif %}
          </form>
        </div>
        <div class="itinerary-block flex flex-col gap-5">
          {% for day in days %}
            <div class="day-block">
              <h3 class="section-title">День {{ day.day_order }}</h3>
              <div class="segments flex flex-col gap-3">
                {% for segment in day.segments %}
                  {% if segment.type == POI_TYPE %}
                    <div class="poi"
                         data-lat="{{ segment.poi.lat }}"
                         data-lon="{{ segment.poi.lon }}"
                         data-name="{{ segment.poi.name }}">
                      <p>
                        <b>{{ segment.poi.name }}</b> — с {{ segment.poi.open_time }} до {{ segment.poi.close_time }} (Рейтинг: {{ segment.poi.rating }})
                      </p>
                    </div>
                  {% elif segment.type == MEAL_TYPE %}
                    <p>{{ segment.meal_type }}</p>
                    <div class="flex flex-col gap-3">
                      {% for meal_p in segment.meal_places %}
                        <label class="flex flex-col gap-2">
                          <input onchange="updateBudget()"
                                 type="radio"
                                 name="meal_{{ day.day_order }}_{{ segment.meal_type }}"
                                 value="{{ meal_p.id }}"
                                 data-cost="{{ meal_p.avg_check_rub }}"
                                 class="peer hidden"
                                 {% if loop.first %}checked{% endif %}>
                          <div class="peer-checked:ring-2 peer-checked:ring-blue-500 px-4 py-5 rounded w-full">
                            {{ meal_p.name }} — {{ meal_p.avg_check_rub }}₽
                          </div>
                          <button class="show-simular-spots peer-checked:flex btn-secondary w-fit flex-start hidden"
                                  data-meal-place-name="{{ meal_p.name }}"
                                  data-meal-place-id="{{ meal_p.id }}">Показать похожие места</button>
                        </label>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
              {% if not loop.last and day.lodgings %}
                <p>Ночлег:</p>
                {% for l in day.lodgings %}
                  <label>
                    <input onchange="updateBudget()" type="radio" name="lodgings">
                    {{ l.type }} - {{ l.name }} {{ l.distance_km }} км от центра
                  </label>
                {% endfor %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div class="budget-box sticky bottom-0 bg-white border-t p-4 mt-6 shadow">
          <strong>Оценка бюджета:</strong> <span id="budgetAmount">0</span> ₽
        </div>
      </div>
    </div>
    <div class="itinerary-right">
      <div id="map" class="map-box"></div>
    </div>
  </body>
{% endblock %}
