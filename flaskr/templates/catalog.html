<!-- templates/index.html -->
{% extends 'base.html' %}

{% block title %}Главная{% endblock %}

{% block content %}
  <h1>Каталог маршрутов</h1>
  <div id="cards">
    {% for r in routes %}
      <div class="route-card"
        data-start-lat="{{ r.start_coords[0] }}"
        data-start-lon="{{ r.start_coords[1] }}">
        <img src="{{ r.img }}" alt="{{ r.title }}">
        <div class="route-info">
          <h2 class="route-title">{{ r.title }}</h2>
          <div class="route-meta">
            <span class="days-trip"><i class="material-icons-round">date_range</i> {{ r.duration_days }} дня</span><span>•</span>
            <span class="hours-road"><i class="material-icons-round">schedule</i><span class="road_time">–</span></span><span>•</span> 
            <span class="budget"><i class="material-icons-round">currency_ruble</i> {{ r.estimated_budget_rub }}</span>
          </div>
          <div class="route-poi">
            {% for poi in r.pois %}
            {{poi.name}} •
            {% endfor %} др.
          </div>
          <div class="route-actions">
            <a href="{{ url_for('trip_setup') }}?routeId={{ r.id }}" class="btn">
              Просмотр маршрута
            </a>
          </div>
        </div>
      </div>
    {% else %}
      <p>Маршрутов не найдено.</p>
    {% endfor %}

{% endblock %}
{% block script %}
<script>
function formatHours(hours) {
  const n = Math.round(hours);
  const rem100 = n % 100;
  const rem10  = n % 10;
  let word;
  if (rem100 >= 11 && rem100 <= 14) {
    word = 'часов';
  } else if (rem10 === 1) {
    word = 'час';
  } else if (rem10 >= 2 && rem10 <= 4) {
    word = 'часа';
  } else {
    word = 'часов';
  }
  return `${n} ${word}`;
}

// 1) получаем геолокацию
let userCoords = [55.75, 37.61];
document.getElementById('geoBtn').onclick = () => {
  navigator.geolocation.getCurrentPosition(p=> {
    userCoords = [p.coords.latitude, p.coords.longitude];
    updateDistances();
  });
};
document.getElementById('manualLocation').onchange = e => {
  const [, lat, lon] = e.target.value.split(',');
  userCoords = [parseFloat(lat), parseFloat(lon)];
  updateDistances();
};
// 2) рассчитываем haversine
function haversine(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
// 3) для каждой карточки берём data-атрибуты
function updateDistances() {
  document.querySelectorAll('.route-card').forEach(card => {
    const lat = parseFloat(card.dataset.startLat);
    const lon = parseFloat(card.dataset.startLon);
    if (!isNaN(lat)) {
      const km = haversine(userCoords[0],userCoords[1],lat,lon);
      card.querySelector('.route-meta .road_time').textContent = 
        `${formatHours(km / 60)}`;
    }
  });
}


function updateBudget() {
  let total = 0;
  
  // Парсим отмеченные radio
  document.querySelectorAll('input[type=radio]:checked').forEach(input => {
    const cost = parseInt(input.dataset.cost || 0);
    if (!isNaN(cost)) total += cost;
  });
  
  document.getElementById('budgetAmount').textContent = total;
}
window.updateBudget = updateBudget;

// 4) при загрузке сразу запустить
updateDistances();
</script>
{% endblock %}
