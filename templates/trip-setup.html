<!-- <!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–ª–∞–Ω –ø–æ–µ–∑–¥–∫–∏</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container" id="app">
  –®–∞–≥ 1: –≤—ã–±–æ—Ä POI –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
  <div id="step1">
    
    <div id="poiList" class="list"></div>
    <div id="minCost" class="small" style="margin:12px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: –∑–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="voteSection"></div>
    <div style="text-align:center; margin:12px;">
      <button id="toDetailsBtn">‚Üí –î–∞–ª–µ–µ: –≤—ã–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª–∏</button>
    </div>
  </div>

  –®–∞–≥ 2: –¥–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏ 
  <div id="step2" style="display:none;">
    <–ó–¥–µ—Å—å –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ renderItinerary: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø–æ–≥–æ–¥–∞, —Å–µ–≥–º–µ–Ω—Ç—ã, meals, lodging, summary
    <div id="extraButtons" style="text-align:center;margin:24px 0;"></div>

  </div>
</div>
<script src="main.js"></script>
</body>
</html> -->
{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">{{ itinerary.title }}</div>
</div>
<button style="margin-bottom: 20px;" class="invite-button" onclick="copyInviteLink()">
üë§‚ûï  –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π
</button>

<div class="card">
  <div class="card-header">–í–∞—Ä–∏–∞–Ω—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ (POI)</div>
</div>
<form action="/api/session/{{ itinerary.session_id }}/vote" method="POST" id="vote-form">
  <div id="poiList">
    {% for day in itinerary.day_variants %}
      <div class="section-title">–î–µ–Ω—å {{ day.day }}</div>
      {% for variant in day.variants %}
        <div class="route-card">
          <div class="marker">{{ day.day }}.{{ loop.index }}</div>
          <div style="flex:1">
            <label class="route-radio">
              <input type="radio" name="day{{ day.day }}" value="{{ variant.variant_id }}" {% if loop.first %}checked{% endif %}>
              <span class="route-title">{{ variant.name }}</span>
            </label>
            <div class="route-pois">
              {{ variant.segments | selectattr("type", "equalto", "poi") | map(attribute="poi_name") | slice(3) | join(" ‚Üí ") }}
              {% if variant.segments | selectattr("poi_name", "defined") | list | length > 3 %}‚Ä¶{% endif %}
            </div>
          </div>
        <span class="cost-pill" data-cost="{{ variant.est_budget }}">–æ—Ç {{ variant.est_budget }} ‚ÇΩ</span>
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <div id="voteSection">
    <div id="minCost">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç {{ itinerary.min_cost }} ‚ÇΩ</div>
    <button id="castVotePOI" style="margin:12px;">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ POI-–º–∞—Ä—à—Ä—É—Ç</button>
  </div>
</form>
<div id="votes-block">
  <h3>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –µ—â–µ –∏–¥–µ—Ç</h3>
  <ul id="votes-list">
    {% for v in votes %}
      <li>
        {{ v.name }} –≤—ã–±—Ä–∞–ª:
        {% for day, var in v.choices.items() %}
          {{ day }}-–π –¥–µ–Ω—å ({{ var }}){% if not loop.last %}, {% endif %}
        {% endfor %}
      </li>
    {% endfor %}
  </ul>
</div>
{% if voting_complete %}
  <div class="vote-summary">
    <p>–ë–æ–ª—å—à–µ –≥–æ–ª–æ—Å–æ–≤ —Å–æ–±—Ä–∞–ª–∏ —Å–ª–µ–¥. –≤–∞—Ä–∏–∞–Ω—Ç—ã:</p>
    {% for day, winner in winners.items() %}
      <p>–ù–∞ {{ day }}-–π –¥–µ–Ω—å –≤—ã–±—Ä–∞–Ω {{ winner }}</p>
    {% endfor %}
  </div>
{% endif %}
{% if voting_complete %}
<a href="{{ url_for('trip_itinerary', session_id=session_id) }}" class="btn">
    –ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞—Ä—à—Ä—É—Ç—É
  </a>
{% else %}
  <button class="btn" disabled>–û–∂–∏–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
{% endif %}


<div style="margin-top: 20px;">
</div>
{% if show_modal %}
<div id="nameModal" class="modal" style="display: block;">
  <div class="modal-content">
    <h3>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</h3>
    <form id="nameForm">
      <input type="text" id="nameInput" name="name" placeholder="–í–∞—à–µ –∏–º—è" required>
      <button type="submit">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </form>
  </div>
</div>
<div class="modal-backdrop"></div>
{% endif %}

{% endblock %}
{% block script %}
<script>
  function recalculateTotalCost() {
  let total = 0;
  const selectedRadios = document.querySelectorAll('#poiList input[type="radio"]:checked');
  selectedRadios.forEach(radio => {
    const container = radio.closest('.route-card');
    const costText = container.querySelector('.cost-pill')?.dataset.cost;
    const cost = parseInt(costText || "0", 10);
    total += cost;
  });

  const minCostDiv = document.getElementById("minCost");
  if (minCostDiv) {
    minCostDiv.textContent = "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç " + total + " ‚ÇΩ";
  }
}

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–π
document.addEventListener("DOMContentLoaded", () => {
  recalculateTotalCost();

  // –î–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
  document.querySelectorAll('#poiList input[type="radio"]').forEach(radio => {
    radio.addEventListener("change", recalculateTotalCost);
  });
});

  document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("nameForm");
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("nameInput").value;

      const res = await fetch("/api/save-name", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          session_id: "{{ session_id }}",
          name: name
        })
      });

      const result = await res.json();
      if (result.status === "ok") {
        window.location.reload();
      } else {
        alert("–û—à–∏–±–∫–∞: " + result.message);
      }
    });
  }
});

function copyInviteLink() {
  const link = `${window.location.origin}/trip-setup?session_id={{ itinerary.session_id }}`;
  navigator.clipboard.writeText(link);
  alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: " + link);
}
document.getElementById("vote-form").addEventListener("submit", async function (e) {
  e.preventDefault(); // –æ—Ç–º–µ–Ω—è–µ–º –æ–±—ã—á–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

  const form = e.target;
  const formData = new FormData(form);

  const sessionId = "{{ itinerary.session_id }}"; // –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ Flask
  const response = await fetch(`/api/session/${sessionId}/vote`, {
    method: "POST",
    body: formData
  });

  const result = await response.json();
  const votesList = document.getElementById("votes-list");

  if (result.status === "ok") {
    const messageElement = document.createElement("li"); // –∏–ª–∏ "div", –µ—Å–ª–∏ –Ω–∞–¥–æ
    messageElement.textContent = result.message;
    votesList.appendChild(messageElement);
  } else {
    resultDiv.textContent = "–û—à–∏–±–∫–∞: " + result.message;
    resultDiv.style.color = "red";
  }
});
</script>

{% endblock %}
