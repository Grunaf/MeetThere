{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-header">{{ itinerary.title }}</div>
</div>
<div class="card-body">
  <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–µ–∑–¥–∫–∏:</label>
  <input type="date" name="visible_start_date" id="startDate"    value="{{ session.check_in.strftime('%Y-%m-%d') if session.check_in else '' }}" required>
</div>

{% if transports_to %}
<div class="card">
  <div class="card-header">–í—ã–±–æ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</div>    
  <div class="card-body">
    <strong style="display: block;">–¢—É–¥–∞:</strong><br>
    {% for transport in (transports_to.transport_data_json | loads)[:5] %}
      <label class="transport-label">
        <input type="radio" name="transport_to" {% if loop.first %}checked{% endif %} data-cost="{% if transport.tickets_info and transport.tickets_info.places and transport.tickets_info.places[0].price %}{{ transport.tickets_info.places[0].price.whole }}{% endif %}">
        <span class="info">
          –ù–æ–º–µ—Ä —Ä–µ–π—Å–∞: {{ transport.thread.number }} ({{ transport.thread.translated_type  }}):
          {{ transport.from.title }} ‚Üí {{ transport.to.title }},
          {{ transport.departure | replace("T", " ") }} ‚Äì {{ transport.arrival | replace("T", " ") }},
          {{ (transport.duration // 60)|int }} –º–∏–Ω
          {% if transport.tickets_info and transport.tickets_info.places and transport.tickets_info.places[0].price %}
            ‚Äî {{ transport.tickets_info.places[0].price.whole }} ‚ÇΩ
          {% else %}
            ‚Äî —Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
          {% endif %}
        </span>
      </label>
      
      {% endfor %}
      {% if transports_from %}
    <div class="transport-options">
      <strong style="display: block;">–û–±—Ä–∞—Ç–Ω–æ:</strong><br>
      {% for transport in (transports_from.transport_data_json | loads)[:5] %}
      <label class="transport-label">
        <input type="radio" name="transport_from" {% if loop.first %}checked{% endif %} data-cost="{% if transport.tickets_info and transport.tickets_info.places and transport.tickets_info.places[0].price %}{{ transport.tickets_info.places[0].price.whole }}{% endif %}">
        <span class="info">
          –ù–æ–º–µ—Ä —Ä–µ–π—Å–∞: {{ transport.thread.number }} ({{ transport.thread.translated_type  }}):
          {{ transport.from.title }} ‚Üí {{ transport.to.title }},
          {{ transport.departure | replace("T", " ") }} ‚Äì {{ transport.arrival | replace("T", " ") }},
          {{ (transport.duration // 60)|int }} –º–∏–Ω
          {% if transport.tickets_info and transport.tickets_info.places and transport.tickets_info.places[0].price %}
            ‚Äî {{ transport.tickets_info.places[0].price.whole }} ‚ÇΩ
          {% else %}
            ‚Äî —Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
          {% endif %}
        </span>
      </label>      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>
{% else %}
<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞.</p>
{% endif %}


<div class="card">
  <div class="card-header">–ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</div>
  <div class="card-body">
    <label>
    <input type="radio" name="wheather_condition" checked value="with_walk">
      –° –ø—Ä–æ–≥—É–ª–∫–∞–º–∏ (—Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞)
    </label><br>
    <label>
    <input type="radio" name="wheather_condition" value="without_walk">
      –ë–µ–∑ –ø—Ä–æ–≥—É–ª–æ–∫ (–ø–∞—Å–º—É—Ä–Ω–∞—è –ø–æ–≥–æ–¥–∞)
    </label><br>
  </div>
</div>
{% for day in days %}
  <div class="card">
    <div class="card-header">–î–µ–Ω—å {{ day.day_number }}</div>
    <div class="card-body">
      {% for seg in day.segments %}
      {% if seg.type == 'poi' %}
        <div class="segment" data-title="{{ seg.poi_name|lower }}" style="margin-bottom: 12px;">
          <strong>{{ seg.poi_name }}</strong><br>

          {% set desc = seg.poi_description_json | loads %}
          {% if desc %}
            {% if desc.hours %}–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: {{ desc.hours }}<br>{% endif %}
            {% if desc.closed_on %}–í—ã—Ö–æ–¥–Ω–æ–π: {{ desc.closed_on }}<br>{% endif %}
            {% if desc.rating %}–†–µ–π—Ç–∏–Ω–≥: {{ desc.rating }}<br>{% endif %}
            {% if desc.ticket_price_rub is not none %}–ë–∏–ª–µ—Ç: {{ desc.ticket_price_rub }} ‚ÇΩ<br>{% endif %}
            {% if desc.note %}<em>{{ desc.note }}</em><br>{% endif %}
          {% else %}
            <em>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</em><br>
          {% endif %}

          {% if seg.arrival_window %}–í—Ä–µ–º—è –ø–æ –ø–ª–∞–Ω—É: {{ seg.arrival_window }}<br>{% endif %}
        </div>
        {% elif seg.type == 'meal' %}
          <div style="margin-bottom: 8px;">
            <strong>{{ seg.meal_type|capitalize }}:</strong><br>
            {% for option in seg.meal_options_json | loads %}
              <label>
                <input type="radio" name="meal{{ seg.id }}" {% if loop.first %}checked{% endif %} data-cost="{{ option.avg_check_rub }}">
                {{ option.name }} ‚Äî {{ option.avg_check_rub }}‚ÇΩ
              </label><br>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
      {% if not loop.last %}
        <div><strong>–í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–æ—á—ë–≤–∫–∏:</strong><br>
        {% for lodging in day.lodgings %}
          <label>
            <input type="radio" name="lodging{{ day.day_number }}" {% if loop.first %}checked{% endif %} data-cost="{{ lodging.avg_check_rub }}">
            {{ lodging.name }} ‚Äî {{ lodging.avg_check_rub }}‚ÇΩ
          </label><br>
        {% endfor %}

        </div>
      {% endif %}
    </div>
  </div>
{% endfor %}
<div class="card">
  <div class="card-header">–ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</div>
  <div class="card-body">
    <p>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:<span id="totalCost"> {{ itinerary.total_cost }}</span> ‚ÇΩ</p>
  </div>
</div>  
<form action="{{ url_for('export_pdf_from_form') }}" method="POST" id="exportForm">
  <input type="hidden" name="session_id" value="{{ session.id }}">
  <input type="hidden" name="selected_transport_from">
  <input type="hidden" name="selected_transport_to">
  <input type="hidden" name="selected_meals">
  <input type="hidden" name="selected_lodgings">
  <input type="hidden" name="start_date">
  <input type="hidden" name="totalCost">
  <button type="submit" class="btn">üìÑ –°–∫–∞—á–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ PDF</button>
  
</form>

{% endblock %}
{% block script %}
<script>
  document.querySelectorAll('input[name="wheather_condition"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const withoutWalks = radio.value === 'without_walk';

      document.querySelectorAll('.segment').forEach(el => {
        const title = el.dataset.title || '';
        if (withoutWalks && title.includes('–ø—Ä–æ–≥—É–ª–∫–∞')) {
          el.style.display = 'none';
        } else {
          el.style.display = '';
        }
      });
    });
  });

  const dateInput = document.getElementById("startDate");
  dateInput.addEventListener("change", function () {
    const startDate = this.value;
    const sessionId = "{{ session.id }}";

    fetch("/update-transport", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        session_id: sessionId,
        start_date: startDate
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        location.reload();  // üîÅ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞");
      }
    });
  });

  document.getElementById("exportForm").addEventListener("submit", function (e) {
    const transportRadios = document.querySelectorAll('input[name="transport_from"]:checked');
    const meals = [];
    const lodgings = [];

    document.querySelectorAll('input[name^="meal"]').forEach(el => {
      if (el.checked) {
        meals.push({
          name: el.parentElement.innerText.trim().split("‚Äî")[0].trim(),        });
      }
    });

    document.querySelectorAll('input[name^="lodging"]').forEach(el => {
      if (el.checked) {
        lodgings.push({
          name: el.nextSibling.textContent.trim().split("‚Äî")[0].trim(),
        });
      }
    });

    const selectedTransportFrom = document.querySelector('input[name="transport_from"]:checked');
    const selectedTransportFromValue = selectedTransportFrom?.closest("label")?.querySelector("span.info")?.innerText.trim() || '';
    const selectedTransportTo = document.querySelector('input[name="transport_to"]:checked');
    const selectedTransportToValue = selectedTransportTo?.closest("label")?.querySelector("span.info")?.innerText.trim() || '';

    const startDate = document.getElementById("startDate")?.value || "";
    const totalCost = document.getElementById("totalCost")?.textContent.trim() || "";

    document.querySelector('input[name="selected_transport_from"]').value = selectedTransportFromValue;
    document.querySelector('input[name="selected_transport_to"]').value = selectedTransportToValue;
    document.querySelector('input[name="selected_meals"]').value = JSON.stringify(meals);
    document.querySelector('input[name="selected_lodgings"]').value = JSON.stringify(lodgings);
    document.querySelector('input[name="start_date"]').value = startDate;
    document.querySelector('input[name="totalCost"]').value = totalCost;
  });

  function recalculateTotal() {
    let total = 0;
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
      const cost = parseInt(radio.dataset.cost);
      if (!isNaN(cost)) total += cost;
    });
    document.getElementById('totalCost').textContent = total;
  }

  // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', recalculateTotal);
    });
    recalculateTotal();  // –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç
  });
</script>
{% endblock %}
